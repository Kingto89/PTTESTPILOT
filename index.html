<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PT Lab ‚Äî Goniometry Trainer</title>

<script type="importmap">
{
  "imports": {
    "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
    "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
  }
}
</script>

<style>
  html,body{margin:0;height:100%;background:#0b1220;color:#e5e7eb;overflow:hidden;font-family:system-ui,Segoe UI,Roboto}
  canvas{position:fixed; inset:0; z-index:0; width:100%; height:100%; display:block}

  .panel{
    position:fixed; left:0; top:0; bottom:0; width:340px;
    background:#0f172a; border-right:1px solid #1f2937; padding:14px; overflow:auto; z-index:50;
  }
  h3{margin:8px 0 12px 0}
  label{display:block;font-size:13px;margin-top:10px;color:#cbd5e1}
  select,button,input[type=range]{width:100%;margin:6px 0 8px 0;padding:8px 10px;border-radius:10px;background:#1e293b;border:1px solid #334155;color:#e2e8f0}
  .row{display:flex;gap:8px}.row>button{flex:1}
  #log{background:#0b1220;border:1px solid #1f2937;height:130px;overflow:auto;border-radius:8px;padding:8px}

  .pill{border:2px solid #334155;border-radius:12px;padding:6px 10px;display:flex;flex-direction:column;align-items:center;gap:2px;font-weight:600}
  .pill .top{display:flex;align-items:center;gap:6px}
  .pill.orange{border-color:#f59e0b}.pill.red{border-color:#ef4444}.pill.green{border-color:#22c55e}

  .hide{display:none}.lockOn{background:#0b3a1f;border-color:#16a34a}
  .hud{position:fixed;top:10px;left:50%;transform:translateX(-50%);background:rgba(15,23,42,.75);border:1px solid #334155;border-radius:10px;padding:6px 10px;font-weight:700;backdrop-filter:blur(6px);z-index:40}
  .toast{position:fixed;bottom:10px;left:50%;transform:translateX(-50%);background:rgba(2,6,23,.7);border:1px solid #334155;border-radius:10px;padding:6px 10px;font-size:13px;display:none;z-index:40}
  #msg{position:fixed;top:10px;left:10px;background:rgba(15,23,42,.7);border:1px solid #334155;border-radius:8px;padding:6px 10px;font-size:13px;z-index:40}

  /* Controllers accordion */
  details.ctrl{border:1px solid #334155;border-radius:10px;margin:8px 0;background:#0b1220}
  details.ctrl > summary{list-style:none;cursor:pointer;padding:10px 12px;font-weight:700}
  details.ctrl[open] > summary{background:#0f172a;border-bottom:1px solid #1f2937;border-top-left-radius:10px;border-top-right-radius:10px}
  details.ctrl > div{padding:10px 12px}

  /* Note bubble */
  .note{
    position:fixed; right:16px; bottom:16px; width:min(520px, 90vw);
    background:rgba(2,6,23,.8); border:1px solid #334155; border-radius:12px;
    padding:12px; z-index:45; backdrop-filter: blur(6px); text-align:left;
  }
  .note h4{margin:0 28px 6px 0}
  .note .x{
    position:absolute; right:10px; top:8px; cursor:pointer;
    border:0; background:transparent; color:#94a3b8; font-size:18px;
  }
  .note .md *{margin:0 0 6px 0; line-height:1.35}
  .note .md ul{padding-left:18px}

  /* SVG goniometer look */
  #gonioHost{position:fixed; inset:0; z-index:30; pointer-events:none}
  #gonioHost svg{width:100vw;height:100vh;background:transparent;pointer-events:auto}
  .tick{stroke:#64748b;stroke-width:.9}.tickBig{stroke-width:1.6}
  .labelOuter{fill:#e5e7eb;font-size:11px;text-anchor:middle;dominant-baseline:middle;paint-order:stroke;stroke:#0b1220;stroke-width:3px}
  .labelInner{fill:#fca5a5;font-size:8.2px;text-anchor:middle;dominant-baseline:middle;paint-order:stroke;stroke:#0b1220;stroke-width:3px}
  .rulerTick{stroke:#94a3b8}
  .ruLbl{fill:#cbd5e1;font-size:9.5px;dominant-baseline:middle;paint-order:stroke;stroke:#0b1220;stroke-width:3px}
</style>
</head>
<body>
<div class="panel">
  <h3>Goniometry Trainer</h3>

  <label>Region</label>
  <select id="regionSel">
    <option value="cervical_spine">Cervical Spine</option>
    <option value="thoracic_lumbar_spine">Thoracic & Lumbar Spine</option>
    <option value="glenohumeral_joint">Glenohumeral Joint</option>
    <option value="elbow_radioulnar">Elbow & Radioulnar Joints</option>
    <option value="wrist">Wrist</option>
    <option value="hip">Hip</option>
    <option value="knee">Knee</option>
    <option value="talocrural_ankle">Talocrural (Ankle)</option>
    <option value="transverse_tarsal_subtalar">Transverse Tarsal & Subtalar</option>
    <option value="fingers_mcp_pip_dip">Fingers (MCP, PIP, DIP)</option>
    <option value="thumb_cmc_mcp_ip">Thumb (CMC, MCP, IP)</option>
    <option value="toes_mtp_pip_dip">Toes (MTP, PIP, DIP)</option>
  </select>

  <label>Motion</label>
  <select id="motionSel"></select>

  <div class="row">
    <button id="showNote">üìå Show goniometer placement</button>
  </div>

  <div class="row">
    <button class="pill orange" id="pickFulcrum">
      <span class="top">üüß <strong>1</strong></span><span>Fulcrum</span>
    </button>
    <button class="pill red" id="pickStationary">
      <span class="top">üü• <strong>2</strong></span><span>Stationary</span>
    </button>
    <button class="pill green" id="pickMoving">
      <span class="top">üü© <strong>3</strong></span><span>Moving</span>
    </button>
  </div>

  <label>Options</label>
  <div class="row">
    <button id="resetAll">Reset</button>
  </div>

  <div class="row">
    <button id="measureToggle">üß≠ Measure: ON</button>
  </div>

  <label>Interaction Locks</label>
  <div class="row">
    <button id="lock3D">üîì 3D: Unlocked</button>
    <button id="lockGonio">üîì Gonio: Unlocked</button>
  </div>

  <h4 style="margin:12px 0 4px;">Controllers</h4>
  <div style="opacity:.6;font-size:12px;margin-bottom:6px">tap a section to focus</div>

  <details id="ctrl_gonio" class="ctrl">
    <summary>Goniometer</summary>
    <div>
      <label>Gonio Size (10‚Äì200%)</label>
      <input type="range" min="10" max="200" step="5" value="100" id="gonioSize">
      <label>Rotate Moving Arm (ROM ¬∞)</label>
      <input type="range" min="0" max="180" step="1" value="30" id="rotateMove">  <!-- relative -->
      <label>Rotate Goniometer (¬∞)</label>
      <input type="range" min="0" max="360" step="1" value="0" id="rotateGonio">
    </div>
  </details>

  <details id="ctrl_model" class="ctrl">
    <summary>Model ‚Äî drag = yaw, pinch = zoom, 2-finger drag = move</summary>
    <div>
      <label>Model X (m)</label><input id="modelX" type="range" min="-2" max="2" step="0.01" value="0">
      <label>Model Z (m)</label><input id="modelZ" type="range" min="-2" max="2" step="0.01" value="0.6">
      <label>Model Y (m)</label><input id="modelY" type="range" min="0" max="1" step="0.01" value="0">
      <label>Model Yaw (¬∞)</label><input id="modelYaw" type="range" min="0" max="360" step="1" value="0">
      <label>Model Scale</label><input id="modelScale" type="range" min="0.6" max="1.6" step="0.01" value="1.0">
    </div>
  </details>

  <details id="ctrl_room" class="ctrl">
    <summary>Room ‚Äî drag X = yaw, drag Y = pitch</summary>
    <div>
      <label>Room Yaw (¬∞)</label><input id="roomYaw" type="range" min="-180" max="180" step="1" value="0">
      <label>Room Pitch (¬∞)</label><input id="roomPitch" type="range" min="-30" max="30" step="1" value="0">
    </div>
  </details>

  <label>Range of Motion</label>
  <div class="row">
    <button id="startROM">‚ñ∂Ô∏è Start ROM</button>
    <button id="resetROM">‚Ü∫ Reset ROM</button>
  </div>

  <label>Event Log</label>
  <pre id="log"></pre>
</div>

<!-- SVG goniometer (transparent center) -->
<div id="gonioHost" class="hide" aria-hidden="true">
  <svg id="gonioSvg" aria-label="Universal goniometer">
    <g id="viewport" transform="translate(0,0) scale(1)">
      <g id="rotWrap" transform="rotate(0)">
        <g id="instrument">
          <g id="head">
            <circle r="120" fill="none" stroke="#94a3b8" stroke-width="1.6"/>
            <circle r="86"  fill="none" stroke="#94a3b8" stroke-width="0.9" opacity="0.65"/>
            <g id="ticks"></g>
            <g id="labelsFixed">
              <g id="numsOut"></g>
              <g id="numsInWrap"><g id="numsIn"></g></g>
            </g>
            <circle r="3.2" fill="#94a3b8"/>
          </g>

          <!-- Stationary arm (red) -->
          <g id="armA_grp">
            <rect x="-10" y="120" width="20" height="260" rx="10" stroke="#ef4444" fill="none" stroke-width="3"/>
            <line id="axisA" x1="0" y1="380" x2="0" y2="-116" stroke="#ef4444" stroke-width="1.6" opacity=".85" stroke-linecap="round"/>
            <g id="armA_ruler"></g>
            <circle id="armA_knob" cx="0" cy="380" r="10" fill="#ef4444"/>
          </g>

          <!-- Moving arm (green) -->
          <g id="armB_grp">
            <rect x="-10" y="-380" width="20" height="500" rx="10" stroke="#22c55e" fill="none" stroke-width="3"/>
            <line id="axisB" x1="0" y1="-380" x2="0" y2="124" stroke="#22c55e" stroke-width="1.6" opacity=".85" stroke-linecap="round"/>
            <g id="armB_ruler"></g>
            <circle id="armB_knob" cx="0" cy="-380" r="10" fill="#22c55e"/>
            <circle id="armB_handleKnob" cx="0" cy="-380" r="38" fill="rgba(0,0,0,0)" style="pointer-events:all"/>
            <rect   id="armB_handleShaft" x="-20" y="-380" width="40" height="500" fill="rgba(0,0,0,0)" style="pointer-events:all"/>
          </g>
        </g>
      </g>
    </g>
  </svg>
</div>

<div id="msg">Loading‚Ä¶</div>
<div class="hud" id="hud">Angle: 0¬∞</div>
<div class="toast" id="toast">Preset updated</div>
<canvas id="c"></canvas>

<!-- Note bubble -->
<div id="note" class="note hide">
  <button class="x" id="noteClose" aria-label="Close">‚úï</button>
  <h4 id="noteTitle">Note</h4>
  <div id="noteBody" class="md">Loading‚Ä¶</div>
</div>

<script type="module">
import * as THREE from "three";
import { OrbitControls } from "three/addons/controls/OrbitControls.js";
import { GLTFLoader } from "three/addons/loaders/GLTFLoader.js";
import { DRACOLoader } from "three/addons/loaders/DRACOLoader.js";
import { KTX2Loader } from "three/addons/loaders/KTX2Loader.js";
import { MeshoptDecoder } from "three/addons/libs/meshopt_decoder.module.js";
import { EXRLoader } from "three/addons/loaders/EXRLoader.js";

/* ===================== UI / HELPERS ===================== */
const msg = document.getElementById("msg");
const hud = document.getElementById("hud");
const logEl = document.getElementById("log");
const toast = document.getElementById("toast");
const lock3DBtn = document.getElementById("lock3D");
const lockGonioBtn = document.getElementById("lockGonio");
const note = document.getElementById("note");
const noteTitle = document.getElementById("noteTitle");
const noteBody = document.getElementById("noteBody");
document.getElementById("noteClose").onclick = ()=> note.classList.add("hide");

const regionSel = document.getElementById("regionSel");
const motionSel = document.getElementById("motionSel");
const showNoteBtn = document.getElementById("showNote");

const gonioSize = document.getElementById("gonioSize");
const rotateMove = document.getElementById("rotateMove");   // 0..180 relative ROM
const rotateGonio = document.getElementById("rotateGonio");

const modelX = document.getElementById("modelX");
const modelZ = document.getElementById("modelZ");
const modelY = document.getElementById("modelY");
const modelYaw = document.getElementById("modelYaw");
const modelScale = document.getElementById("modelScale");

const roomYaw = document.getElementById("roomYaw");
const roomPitch = document.getElementById("roomPitch");

const ctrlGonio = document.getElementById("ctrl_gonio");
const ctrlModel = document.getElementById("ctrl_model");
const ctrlRoom  = document.getElementById("ctrl_room");

const log = (t)=>{ logEl.textContent += t + "\n"; logEl.scrollTop = logEl.scrollHeight; };

/* ===== Motions per region (for your markdown set) ===== */
const REGION_MOTIONS = {
  cervical_spine: ["Flexion","Extension","Lateral Flexion","Rotation"],
  thoracic_lumbar_spine: ["Flexion","Extension","Lateral Flexion","Rotation"],
  glenohumeral_joint: ["Flexion","Extension","Abduction","Internal Rotation","External Rotation"],
  elbow_radioulnar: ["Flexion","Extension","Pronation","Supination"],
  wrist: ["Flexion","Extension","Radial Deviation","Ulnar Deviation"],
  hip: ["Flexion","Extension","Abduction","Adduction","Internal Rotation","External Rotation"],
  knee: ["Flexion","Extension"],
  talocrural_ankle: ["Dorsiflexion","Plantarflexion"],
  transverse_tarsal_subtalar: ["Inversion","Eversion"],
  fingers_mcp_pip_dip: ["MCP Flexion","MCP Extension","PIP Flexion","PIP Extension","DIP Flexion","DIP Extension"],
  thumb_cmc_mcp_ip: ["CMC Flexion","CMC Extension","CMC Abduction","CMC Adduction","MCP Flexion","MCP Extension","IP Flexion","IP Extension"],
  toes_mtp_pip_dip: ["MTP Flexion","MTP Extension","PIP Flexion","PIP Extension","DIP Flexion","DIP Extension"]
};
function refreshMotions(){
  const list = REGION_MOTIONS?.[regionSel.value] || [];
  motionSel.innerHTML = "";
  (list.length? list : ["(No motions)"]).forEach((t,i)=>{
    const o=document.createElement("option"); o.value=(list.length? t:""); o.textContent=t; if(i===0) o.selected=true; motionSel.appendChild(o);
  });
}
refreshMotions();
regionSel.onchange = refreshMotions;

/* ========== Controller focus (one active at a time) ========== */
let activeCtrl = null;
function focusCtrl(which){
  activeCtrl = which;
  // open selected, close others
  ctrlGonio.open = which==="gonio";
  ctrlModel.open = which==="model";
  ctrlRoom.open  = which==="room";
}
ctrlGonio.addEventListener("toggle", ()=>{ if (ctrlGonio.open) focusCtrl("gonio"); });
ctrlModel.addEventListener("toggle", ()=>{ if (ctrlModel.open) focusCtrl("model"); });
ctrlRoom .addEventListener("toggle", ()=>{ if (ctrlRoom .open) focusCtrl("room"); });
/* collapsed by default */
ctrlGonio.open = ctrlModel.open = ctrlRoom.open = false;

/* ===================== THREE SETUP ===================== */
const canvas = document.getElementById("c");
const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
renderer.setPixelRatio(devicePixelRatio);
renderer.setSize(innerWidth, innerHeight);
renderer.outputColorSpace = THREE.SRGBColorSpace;
renderer.toneMapping = THREE.ACESFilmicToneMapping;
renderer.toneMappingExposure = 1.0;
renderer.shadowMap.enabled = true;
renderer.shadowMap.type = THREE.PCFSoftShadowMap;

const scene = new THREE.Scene();

const camera = new THREE.PerspectiveCamera(45, innerWidth/innerHeight, 0.1, 100);
camera.position.set(0.8, 1.6, 2.5);

const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;

/* lights */
scene.add(new THREE.HemisphereLight(0xffffff, 0x333344, 1.25));
const sun = new THREE.DirectionalLight(0xffffff, 1.2);
sun.position.set(3, 6, 2);
sun.castShadow = true;
sun.shadow.mapSize.set(2048,2048);
sun.shadow.camera.near = 0.1;
sun.shadow.camera.far = 20;
sun.shadow.camera.left = sun.shadow.camera.bottom = -6;
sun.shadow.camera.right = sun.shadow.camera.top = 6;
scene.add(sun);

/* shadow-catching ground at y=0 */
const FLOOR_Y = 0;
const ground = new THREE.Mesh(
  new THREE.PlaneGeometry(40,40),
  new THREE.ShadowMaterial({ opacity: 0.35 })
);
ground.receiveShadow = true;
ground.rotation.x = -Math.PI/2;
ground.position.y = FLOOR_Y;
scene.add(ground);

/* ===== Room EXR on inside sphere + PMREM env ===== */
const pmremGen = new THREE.PMREMGenerator(renderer);
pmremGen.compileEquirectangularShader();

let backgroundSphere = null;
new EXRLoader().setPath("assets/")
  .load("pt_evaluation_room.exr?v="+Date.now(), (tex) => {
    const env = pmremGen.fromEquirectangular(tex);
    scene.environment = env.texture;

    const geo = new THREE.SphereGeometry(12, 96, 96);
    const mat = new THREE.MeshBasicMaterial({ map: tex, side: THREE.BackSide });
    backgroundSphere = new THREE.Mesh(geo, mat);
    scene.add(backgroundSphere);
  }, undefined, (e)=>{
    console.warn("EXR load error", e);
    scene.background = new THREE.Color(0x0b1220);
  });

/* ========== GLTF model ========== */
const loader = new GLTFLoader();
loader.setMeshoptDecoder(MeshoptDecoder);
const draco = new DRACOLoader(); draco.setDecoderPath("https://unpkg.com/three@0.160.0/examples/jsm/libs/draco/");
loader.setDRACOLoader(draco);
const ktx2 = new KTX2Loader(); ktx2.setTranscoderPath("https://unpkg.com/three@0.160.0/examples/jsm/libs/basis/");
ktx2.detectSupport(renderer); loader.setKTX2Loader(ktx2);

let model = null;
const MODEL_URL = "./Athletic_Grace_1006002620_texture.glb";

function plantFeetAndPlace(g){
  g.traverse(o=>{ if(o.isMesh){ o.castShadow = true; o.receiveShadow = false; } });
  const box = new THREE.Box3().setFromObject(g);
  const minY = box.min.y;
  g.position.y -= minY;                  // put feet on y=0
  g.position.y = FLOOR_Y;                // hard lock to floor
  modelX.value = "0"; modelZ.value = "0.6"; modelY.value = FLOOR_Y.toFixed(2);
  modelScale.value = "1.0";
  applyModelTransforms();
}
function applyModelTransforms(){
  if(!model) return;
  const x = parseFloat(modelX.value);
  const z = parseFloat(modelZ.value);
  const y = Math.max(FLOOR_Y, parseFloat(modelY.value));  // clamp to floor
  model.position.set(x, y, z);
  model.rotation.y = THREE.MathUtils.degToRad(parseFloat(modelYaw.value));
  const s = parseFloat(modelScale.value);
  model.scale.setScalar(s);
}

loader.load(MODEL_URL, (gltf)=>{
  model = gltf.scene; scene.add(model);
  plantFeetAndPlace(model);
  msg.textContent = "‚úÖ Model loaded";
}, (xhr)=>{
  msg.textContent = xhr.lengthComputable ? `Loading ${Math.round((xhr.loaded/xhr.total)*100)}%` : "Loading‚Ä¶";
}, (e)=>{
  msg.textContent = "‚ö†Ô∏è Loader error ‚Äî model unavailable";
});

/* ===== Model gesture routing (only when Model controller is active) ===== */
let drag2 = null; // two-finger drag state
renderer.domElement.addEventListener("pointerdown", (e)=>{
  renderer.domElement.setPointerCapture?.(e.pointerId);
});
renderer.domElement.addEventListener("pointermove", (e)=>{
  if(activeCtrl!=="model") return;
  if(e.buttons===1){ // one finger: yaw
    modelYaw.value = ( (parseFloat(modelYaw.value) + e.movementX*0.25) % 360 + 360 ) % 360;
    applyModelTransforms();
  } else if(e.buttons===2 || (e.buttons===1 && e.shiftKey)){ // RMB or shift: two-finger style
    modelX.value = (parseFloat(modelX.value) + e.movementX*0.002).toFixed(2);
    modelZ.value = (parseFloat(modelZ.value) - e.movementY*0.002).toFixed(2);
    applyModelTransforms();
  }
});
renderer.domElement.addEventListener("wheel",(e)=>{
  if(activeCtrl!=="model") return;
  e.preventDefault();
  const s = THREE.MathUtils.clamp(parseFloat(modelScale.value) * (e.deltaY<0?1.03:0.97), 0.6, 1.6);
  modelScale.value = s.toFixed(2);
  applyModelTransforms();
},{passive:false});

/* slider hooks (model) */
[modelX,modelZ,modelY,modelYaw,modelScale].forEach(el=> el.addEventListener("input", applyModelTransforms));

/* ===== Room controls ===== */
function applyRoom(){
  if(!backgroundSphere) return;
  backgroundSphere.rotation.y = THREE.MathUtils.degToRad(parseFloat(roomYaw.value));
  backgroundSphere.rotation.x = THREE.MathUtils.degToRad(parseFloat(roomPitch.value));
}
roomYaw.oninput = roomPitch.oninput = applyRoom;

/* ===== Locks ===== */
let lock3D=false, lockGonio=false;
function set3DLock(v){ lock3D=v; controls.enabled=!lock3D; lock3DBtn.textContent=(lock3D? "üîí 3D: Locked":"üîì 3D: Unlocked"); lock3DBtn.classList.toggle('lockOn', lock3D); }
function setGonioLock(v){
  lockGonio=v;
  document.getElementById('gonioHost').style.pointerEvents = lockGonio ? 'none' : 'auto';
  lockGonioBtn.textContent=(lockGonio? "üîí Gonio: Locked":"üîì Gonio: Unlocked");
  lockGonioBtn.classList.toggle('lockOn', lockGonio);
}
set3DLock(false); setGonioLock(false);
lock3DBtn.onclick = ()=> set3DLock(!lock3D);
lockGonioBtn.onclick = ()=> setGonioLock(!lockGonio);

/* ====== Markdown notes loader ====== */
function mdToHtml(md){
  let html = md
    .replace(/^### (.*)$/gm, '<h5>$1</h5>')
    .replace(/^## (.*)$/gm, '<h4>$1</h4>')
    .replace(/^# (.*)$/gm, '<h3>$1</h3>')
    .replace(/^\* (.*)$/gm, '<li>$1</li>');
  html = html.replace(/(<li>[\s\S]*?<\/li>)/g, '<ul>$1</ul>');
  html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
  return html;
}
function regionToTitle(r){
  return ({
    cervical_spine:"Cervical Spine",
    thoracic_lumbar_spine:"Thoracic & Lumbar Spine",
    glenohumeral_joint:"Glenohumeral Joint",
    elbow_radioulnar:"Elbow & Radioulnar Joints",
    wrist:"Wrist", hip:"Hip", knee:"Knee",
    talocrural_ankle:"Talocrural (Ankle)",
    transverse_tarsal_subtalar:"Transverse Tarsal & Subtalar",
    fingers_mcp_pip_dip:"Fingers (MCP, PIP, DIP)",
    thumb_cmc_mcp_ip:"Thumb (CMC, MCP, IP)",
    toes_mtp_pip_dip:"Toes (MTP, PIP, DIP)"
  }[r]||r.replace(/_/g,' '));
}
async function loadNote(region, motion){
  const url = `content/goniometry/${region}.md?${Date.now()}`;
  try{
    const res = await fetch(url);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const md = await res.text();
    const re = new RegExp(`(^|\\n)##?\\s*${motion}\\s*\\n([\\s\\S]*?)(\\n##?\\s|$)`,'i');
    const m = md.match(re);
    const section = m ? m[2].trim() : md;
    noteTitle.textContent = `${regionToTitle(region)} ‚Äî ${motion}`;
    noteBody.innerHTML = mdToHtml(section || "‚Äî");
  }catch(e){
    console.error(e);
    noteTitle.textContent = `${regionToTitle(region)} ‚Äî ${motion}`;
    noteBody.textContent = "Failed to load note.";
  }
}
showNoteBtn.onclick = async ()=>{
  await loadNote(regionSel.value, motionSel.value || "(General)");
  note.classList.remove("hide");
};

/* ===================== GONIOMETER ===================== */
const Gonio = (() => {
  const host  = document.getElementById('gonioHost');
  const svg   = document.getElementById('gonioSvg');
  const viewport   = document.getElementById('viewport');
  const rotWrap    = document.getElementById('rotWrap');
  const numsInWrap = document.getElementById('numsInWrap');
  const labelsFixed= document.getElementById('labelsFixed');
  const armA_ruler = document.getElementById('armA_ruler');
  const armB_ruler = document.getElementById('armB_ruler');

  const clamp=(v,a,b)=>Math.min(b,Math.max(a,v));
  const clamp360=a=>(a%360+360)%360;
  const toDegUp=(x,y)=>clamp360(Math.atan2(-y,x)*180/Math.PI+90);

  // build dial + rulers
  (function build(){
    const ticks = document.getElementById('ticks');
    const numsOut = document.getElementById('numsOut');
    const numsIn = document.getElementById('numsIn');
    const R=120, Rin=86;
    const line=(p,x1,y1,x2,y2,cls)=>{ const n=document.createElementNS('http://www.w3.org/2000/svg','line'); n.setAttribute('x1',x1);n.setAttribute('y1',y1);n.setAttribute('x2',x2);n.setAttribute('y2',y2); if(cls)n.setAttribute('class',cls); p.appendChild(n); };
    const text=(p,x,y,t,cls,rot)=>{ const n=document.createElementNS('http://www.w3.org/2000/svg','text'); n.setAttribute('x',x); n.setAttribute('y',y); n.setAttribute('class',cls||'labelOuter'); if(rot)n.setAttribute('transform',`rotate(${rot} ${x} ${y})`); n.textContent=t; p.appendChild(n); return n; };
    for(let d=0; d<360; d+=5){ const a=(d-90)*Math.PI/180, big=d%30===0, len=big?12:6; line(ticks,Math.cos(a)*(R-len),Math.sin(a)*(R-len),Math.cos(a)*R,Math.sin(a)*R,big?'tick tickBig':'tick'); }
    const rWhite=R-8;
    for(let d=0; d<360; d+=10){ const diff90=Math.abs(((d-90)%360+540)%360-180); const diff270=Math.abs(((d-270)%360+540)%360-180); const val=Math.min(diff90,diff270); if(val%20===0 && val<=80){ const a=(d-90)*Math.PI/180,x=Math.cos(a)*rWhite,y=Math.sin(a)*rWhite; text(numsOut,x,y,String(val),'labelOuter'); } }
    const rInner=Rin+9, valFromTheta=th=>{const t=(th+180)%360; return t<=180?t:360-t;};
    for(let th=0; th<360; th+=10){ const v=valFromTheta(th); if(v%10!==0) continue; if(v===0 && th!==180) continue; const a=(th-90)*Math.PI/180,x=Math.cos(a)*rInner,y=Math.sin(a)*rInner; text(numsIn,x,y,String(v),'labelInner'); }

    buildTipRuler(armA_ruler, +380, +1, 'A');
    buildTipRuler(armB_ruler, -380, -1, 'B');
    function buildTipRuler(group, tipY, dir, which){
      const CM_TO_PX = 14, IN_TO_CM = 2.5;
      group.innerHTML='';
      const line2=(x1,y1,x2,y2)=>{const n=document.createElementNS('http://www.w3.org/2000/svg','line');n.setAttribute('x1',x1);n.setAttribute('y1',y1);n.setAttribute('x2',x2);n.setAttribute('y2',y2);n.setAttribute('class','rulerTick');group.appendChild(n);};
      const label=(x,y,t,rot)=>{const n=document.createElementNS('http://www.w3.org/2000/svg','text');n.setAttribute('x',x);n.setAttribute('y',y);n.setAttribute('class','ruLbl'); if(rot) n.setAttribute('transform',`rotate(${rot} ${x} ${y})`); n.textContent=t; n.dataset.arm=which; n.dataset.x=x; n.dataset.y=y; group.appendChild(n); return n;};
      const cmMax=15, inMax=6;
      for(let cm=0; cm<=cmMax+1e-6; cm+=0.5){
        const y = tipY - dir*(cm*CM_TO_PX);
        const long = Math.abs(cm - Math.round(cm)) < 1e-6;
        const mid  = !long && Math.abs(cm*2 - Math.round(cm*2)) < 1e-6;
        const w = long?8:mid?5:3; line2(-10,y,-10-w,y);
        if (long) label(-18,y,String(Math.round(cm)),-90);
      }
      for(let inch=0; inch<=inMax+1e-6; inch+=0.5){
        const y = tipY - dir*(inch*IN_TO_CM*CM_TO_PX);
        const long = Math.abs(inch - Math.round(inch)) < 1e-6;
        const mid  = !long && Math.abs(inch*2 - Math.round(inch*2)) < 1e-6;
        const w = long?8:mid?5:3; line2(10,y,10+w,y);
        if (long) label(18,y,String(Math.round(inch)),90);
      }
      label(-26,tipY,'cm',-90); label(26,tipY,'in',90);
    }
  })();

  let movAbs=30; // absolute moving arm heading (0..360)
  let baseRot=0, userRot=0, zoom=1, panX=innerWidth/2, panY=innerHeight/2, scale=1;
  let draggingArm=false, draggingPan=false, lastPan=null;

  function applyView(){ viewport.setAttribute('transform',`translate(${panX},${panY}) scale(${zoom*scale})`); }
  function applyRot(){ rotWrap.setAttribute('transform',`rotate(${baseRot+userRot})`); }
  function applyLabelFix(){ const t=-(baseRot+userRot); labelsFixed.setAttribute('transform',`rotate(${t})`); numsInWrap.setAttribute('transform',`rotate(${-t})`); }
  function render(){
    document.getElementById('armA_grp').setAttribute('transform','rotate(0)');
    document.getElementById('armB_grp').setAttribute('transform',`rotate(${clamp360(movAbs-baseRot)})`);
  }
  function currentAngle(){ const a = clamp360(movAbs-baseRot); return a>180 ? 360-a : a; }

  // interaction
  svg.addEventListener('pointerdown', e=>{
    if (lockGonio) return;
    if (e.target.closest('#armB_grp')){ draggingArm=true; svg.setPointerCapture?.(e.pointerId); return; }
    draggingPan=true; lastPan={x:e.clientX,y:e.clientY}; svg.setPointerCapture?.(e.pointerId);
  });
  svg.addEventListener('pointermove', e=>{
    if (lockGonio) return;
    if (draggingArm){
      const pt = svg.createSVGPoint(); pt.x=e.clientX; pt.y=e.clientY;
      const p = pt.matrixTransform(rotWrap.getScreenCTM().inverse());
      movAbs = toDegUp(p.x, p.y); render(); return;
    }
    if (draggingPan && lastPan){
      const dx=(e.clientX-lastPan.x)/(zoom*scale), dy=(e.clientY-lastPan.y)/(zoom*scale);
      panX+=dx; panY+=dy; lastPan={x:e.clientX,y:e.clientY}; applyView();
    }
  });
  svg.addEventListener('pointerup', ()=>{ draggingArm=false; draggingPan=false; lastPan=null; });
  svg.addEventListener('wheel', e=>{
    if (lockGonio) return;
    e.preventDefault();
    const step=Math.sign(e.deltaY)<0?1.22:1/1.22;
    zoom=clamp(zoom*step,0.07,10); applyView();
  }, {passive:false});

  function show(){ host.classList.remove('hide'); host.setAttribute('aria-hidden','false'); applyView(); applyRot(); applyLabelFix(); render(); }
  function hide(){ host.classList.add('hide'); host.setAttribute('aria-hidden','true'); }
  function setPose(cx,cy,baseDeg,movDegAbs){ panX=cx; panY=cy; baseRot=baseDeg; movAbs=clamp360(movDegAbs); applyView(); applyRot(); applyLabelFix(); render(); }
  function setScale(k){ scale=clamp(k||1,0.1,2); applyView(); }
  function setUserRot(deg){ userRot=clamp360(deg); applyRot(); applyLabelFix(); render(); }
  function setMovDegAbs(deg){ movAbs=clamp360(deg); render(); }
  function setMovDegRel(rel){ movAbs=clamp360(baseRot + clamp(rel,0,180)); render(); } // slider 0..180

  return {
    show, hide, setPose, setScale,
    setUserRot, setMovDegAbs, setMovDegRel,
    get angle(){ return currentAngle(); },
    getMovDegAbs: ()=>clamp360(movAbs), getUserRot: ()=>clamp360(userRot),
    degFromScreenVec:(dx,dy)=>toDegUp(dx,dy),
    refresh: ()=>{ applyView(); applyRot(); applyLabelFix(); render(); }
  };
})();
window.Gonio = Gonio;

/* ===== Goniometer UI wiring ===== */
gonioSize.oninput = ()=> { Gonio.setScale(parseInt(gonioSize.value,10)/100); Gonio.refresh(); };
rotateGonio.oninput = ()=>{ if (lockGonio) return; Gonio.setUserRot(parseFloat(rotateGonio.value)); };
rotateMove.oninput  = ()=>{ if (lockGonio) return; Gonio.setMovDegRel(parseFloat(rotateMove.value)); };

/* ===== Landmarks & measurement alignment ===== */
const ray = new THREE.Raycaster(); const mouse = new THREE.Vector2();
const COLORS = { stationary: 0xef4444, moving: 0x22c55e, fulcrum: 0xf59e0b };
const dot = (color) => new THREE.Mesh(new THREE.SphereGeometry(0.01, 16, 16), new THREE.MeshBasicMaterial({ color }));
const user = { fulcrum: dot(COLORS.fulcrum), stationary: dot(COLORS.stationary), moving: dot(COLORS.moving) };
Object.values(user).forEach(m => { m.visible = false; scene.add(m); });
const userLocal = { fulcrum:null, stationary:null, moving:null };

let target = null;
function toScreen(v3){ const v=v3.clone().project(camera); return { x:(v.x*0.5+0.5)*innerWidth, y:(-v.y*0.5+0.5)*innerHeight }; }
function placePoint(name, worldPoint) {
  if (!model) return;
  const local = model.worldToLocal(worldPoint.clone());
  userLocal[name] = local;
  user[name].visible = true;
  user[name].position.copy(worldPoint);
  log(`${name} placed`);
  updateFromLocals();
}
document.getElementById("pickFulcrum").onclick   = ()=>{ target="fulcrum";   log("Place Fulcrum"); focusCtrl("model"); };
document.getElementById("pickStationary").onclick= ()=>{ target="stationary";log("Place Stationary"); focusCtrl("model"); };
document.getElementById("pickMoving").onclick    = ()=>{ target="moving";    log("Place Moving"); focusCtrl("model"); };

canvas.addEventListener("pointerdown", (e) => {
  if (!target || !model) return;
  const r = canvas.getBoundingClientRect();
  mouse.x = ((e.clientX - r.left) / r.width) * 2 - 1;
  mouse.y = -((e.clientY - r.top) / r.height) * 2 + 1;
  ray.setFromCamera(mouse, camera);
  const hits = ray.intersectObjects([model], true);
  if (!hits.length) return;
  placePoint(target, hits[0].point); target = null;
});

const line1 = new THREE.Line(new THREE.BufferGeometry(), new THREE.LineBasicMaterial({ color: COLORS.stationary }));
const line2 = new THREE.Line(new THREE.BufferGeometry(), new THREE.LineBasicMaterial({ color: COLORS.moving }));
scene.add(line1, line2);

function setAngleHUD(a, romStr=""){ hud.textContent = romStr ? `Angle: ${a.toFixed(0)}¬∞ | ROM: ${romStr}` : `Angle: ${a.toFixed(0)}¬∞`; }

/* ROM tracking */
let romActive = false, romStartDeg = null;
document.getElementById("startROM").onclick = ()=>{ romActive = true; romStartDeg = Gonio.angle; log(`ROM start @ ${romStartDeg.toFixed(0)}¬∞`); };
document.getElementById("resetROM").onclick = ()=>{ romActive = false; romStartDeg = null; log("ROM reset"); };
function romString(){ if (!romActive || romStartDeg==null) return ""; const delta = Math.abs(Gonio.angle - romStartDeg); return `${delta.toFixed(0)}¬∞ (start ${romStartDeg.toFixed(0)}¬∞)`; }

let followMeasure = true;
const measureToggle = document.getElementById("measureToggle");
measureToggle.onclick = ()=>{ followMeasure = !followMeasure; measureToggle.textContent = followMeasure ? "üß≠ Measure: ON" : "üß≠ Measure: OFF"; };

function autoAlignGonioFromDots(f, s, m){
  const Fs = toScreen(f), Ss = toScreen(s), Ms = toScreen(m);
  const baseDeg = Gonio.degFromScreenVec(Ss.x - Fs.x, Ss.y - Fs.y);
  const movDeg  = Gonio.degFromScreenVec(Ms.x - Fs.x, Ms.y - Fs.y);
  Gonio.show(); Gonio.setPose(Fs.x, Fs.y, baseDeg, movDeg);
  rotateGonio.value = Math.round(Gonio.getUserRot());
  rotateMove.value  = Math.round(Gonio.angle); // relative ROM for the slider readout
}
function updateFromLocals(){
  if (!model) return;
  ["fulcrum","stationary","moving"].forEach(k=>{
    if (userLocal[k]) { user[k].position.copy(userLocal[k].clone()).applyMatrix4(model.matrixWorld); user[k].visible = true; }
  });
  const f = user.fulcrum.visible ? user.fulcrum.position : null;
  const s = user.stationary.visible ? user.stationary.position : null;
  const m = user.moving.visible ? user.moving.position : null;

  line1.visible = !!(f && s); line2.visible = !!(f && m);
  if (line1.visible){ line1.geometry.dispose(); line1.geometry = new THREE.BufferGeometry().setFromPoints([f, s]); }
  if (line2.visible){ line2.geometry.dispose(); line2.geometry = new THREE.BufferGeometry().setFromPoints([f, m]); }

  if (f && s && m) {
    autoAlignGonioFromDots(f,s,m);
    if (followMeasure) { followMeasure = false; measureToggle.textContent = "üß≠ Measure: OFF"; log("Measure auto-OFF"); }
  } else { Gonio.hide(); }
}

/* reset & locks text */
document.getElementById("resetAll").onclick = ()=>{
  Object.values(user).forEach(m => m.visible = false);
  userLocal.fulcrum = userLocal.stationary = userLocal.moving = null;
  line1.visible = line2.visible = false; Gonio.hide(); setAngleHUD(0,""); romActive=false; romStartDeg=null; log("Reset");
};

/* ===== Animate ===== */
addEventListener("resize", () => { camera.aspect = innerWidth/innerHeight; camera.updateProjectionMatrix(); renderer.setSize(innerWidth, innerHeight); });

(function animate(){
  controls.enabled = !lock3D;
  controls.update();

  if (model && model.position.y < FLOOR_Y){
    model.position.y = FLOOR_Y;
    modelY.value = FLOOR_Y.toFixed(2);
  }

  if (followMeasure) updateFromLocals();
  if (!document.getElementById('gonioHost').classList.contains('hide')) setAngleHUD(Gonio.angle, romString());

  renderer.render(scene, camera);
  requestAnimationFrame(animate);
})();

/* error hook */
window.addEventListener('error', e => { msg.textContent = '‚ùå ' + (e.message || 'Script error'); console.error(e); });
</script>
</body>
</html>
