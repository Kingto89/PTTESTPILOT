<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PT Lab ‚Äî Goniometry Trainer</title>

<script type="importmap">
{
  "imports": {
    "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
    "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
  }
}
</script>

<style>
  html,body{margin:0;height:100%;background:#0b1220;color:#e5e7eb;overflow:hidden;font-family:system-ui,Segoe UI,Roboto}
  canvas{position:fixed; inset:0; z-index:0; width:100%; height:100%; display:block}

  .panel{
    position:fixed; left:0; top:0; bottom:0; width:340px;
    background:#0f172a; border-right:1px solid #1f2937; padding:14px; overflow:auto; z-index:50;
  }
  #gonioHost{position:fixed; inset:0; z-index:30; pointer-events:none}
  #gonioHost svg{width:100vw;height:100vh;background:transparent;pointer-events:auto}
  .hud,.toast,#msg{z-index:40}
  .hud{position:fixed;top:10px;left:50%;transform:translateX(-50%);background:rgba(15,23,42,.75);border:1px solid #334155;border-radius:10px;padding:6px 10px;font-weight:700;backdrop-filter:blur(6px)}
  .toast{position:fixed;bottom:10px;left:50%;transform:translateX(-50%);background:rgba(2,6,23,.7);border:1px solid #334155;border-radius:10px;padding:6px 10px;font-size:13px;display:none}
  #msg{position:fixed;top:10px;left:10px;background:rgba(15,23,42,.7);border:1px solid #334155;border-radius:8px;padding:6px 10px;font-size:13px}

  h3{margin:8px 0 12px 0}
  label{display:block;font-size:13px;margin-top:10px;color:#cbd5e1}
  select,button,input[type=range]{width:100%;margin:6px 0 8px 0;padding:8px 10px;border-radius:10px;background:#1e293b;border:1px solid #334155;color:#e2e8f0}
  .row{display:flex;gap:8px}.row>button{flex:1}
  #log{background:#0b1220;border:1px solid #1f2937;height:130px;overflow:auto;border-radius:8px;padding:8px}

  .pill{border:2px solid #334155;border-radius:12px;padding:6px 10px}
  .pill.orange{border-color:#f59e0b}
  .pill.red{border-color:#ef4444}
  .pill.green{border-color:#22c55e}

  .hide{display:none}.lockOn{background:#0b3a1f;border-color:#16a34a}

  /* Note bubble */
  .note{
    position:fixed; right:16px; bottom:16px; width:min(520px, 90vw);
    background:rgba(2,6,23,.8); border:1px solid #334155; border-radius:12px;
    padding:12px; z-index:45; backdrop-filter: blur(6px);
  }
  .note h4{margin:0 0 4px 0}
  .note .x{position:absolute; right:8px; top:6px; cursor:pointer; border:0; background:transparent; color:#94a3b8; font-size:18px}
  .note .md *{margin:0 0 6px 0; line-height:1.35}
  .note .md ul{padding-left:18px}

  /* Accordion */
  .acc{margin-top:8px}
  .acc .hdr{
    width:100%; text-align:left; background:#0d162b; border:1px solid #334155;
    border-radius:10px; padding:10px; font-weight:600; display:flex; align-items:center; justify-content:space-between
  }
  .acc .hdr span{opacity:.8;font-weight:500;font-size:12px}
  .acc .body{display:none; padding:8px 6px 2px 6px}
  .acc.open .body{display:block}

  /* Sub-accordion inside Controllers */
  .sub{margin-top:8px; border:1px solid #22304a; border-radius:10px}
  .sub .subhdr{width:100%; text-align:left; background:#0c1426; border:0; border-bottom:1px solid #22304a; padding:8px 10px; border-radius:10px 10px 0 0; font-weight:600}
  .sub .subbody{display:none; padding:8px 10px}
  .sub.open .subbody{display:block}
</style>
</head>
<body>
<div class="panel">
  <h3>Goniometry Trainer</h3>

  <label>Region</label>
  <select id="regionSel">
    <option value="cervical_spine">Cervical Spine</option>
    <option value="thoracic_lumbar_spine">Thoracic & Lumbar Spine</option>
    <option value="glenohumeral_joint">Glenohumeral Joint</option>
    <option value="elbow_radioulnar">Elbow & Radioulnar Joints</option>
    <option value="wrist">Wrist</option>
    <option value="hip">Hip</option>
    <option value="knee">Knee</option>
    <option value="talocrural_ankle">Talocrural (Ankle)</option>
    <option value="transverse_tarsal_subtalar">Transverse Tarsal & Subtalar</option>
    <option value="fingers_mcp_pip_dip">Fingers (MCP, PIP, DIP)</option>
    <option value="thumb_cmc_mcp_ip">Thumb (CMC, MCP, IP)</option>
    <option value="toes_mtp_pip_dip">Toes (MTP, PIP, DIP)</option>
  </select>

  <label>Motion</label>
  <select id="motionSel"></select>

  <div class="row">
    <button id="showNote">üìå Show goniometer placement</button>
  </div>

  <div class="row">
    <button class="pill orange" id="pickFulcrum">üüß 1 Fulcrum</button>
    <button class="pill red" id="pickStationary">üü• 2 Stationary</button>
    <button class="pill green" id="pickMoving">üü© 3 Moving</button>
  </div>

  <label>Options</label>
  <div class="row">
    <button id="toggleGhost">üëª Ghost Landmarks</button>
    <button id="resetAll">Reset</button>
  </div>

  <div class="row">
    <button id="measureToggle">üß≠ Measure: ON</button>
  </div>

  <label>Interaction Locks</label>
  <div class="row">
    <button id="lock3D">üîì 3D: Unlocked</button>
    <button id="lockGonio">üîì Gonio: Unlocked</button>
  </div>

  <!-- CONTROLLERS (single dropdown) -->
  <div class="acc" id="acc-controllers">
    <button class="hdr" type="button"><div>Controllers</div><span>tap to show</span></button>
    <div class="body">

      <div class="sub open" id="sub-gonio">
        <button class="subhdr" type="button">Goniometer</button>
        <div class="subbody">
          <label>Gonio Size (10‚Äì200%)</label>
          <input type="range" min="10" max="200" step="5" value="100" id="gonioSize">
          <label>Rotate Moving Arm (¬∞)</label>
          <input type="range" min="0" max="360" step="1" value="30" id="rotateMove">
          <label>Rotate Goniometer (¬∞)</label>
          <input type="range" min="0" max="360" step="1" value="0" id="rotateGonio">
        </div>
      </div>

      <div class="sub" id="sub-model">
        <button class="subhdr" type="button">Model <span style="opacity:.7;font-weight:500">‚Äî drag = yaw, pinch = zoom</span></button>
        <div class="subbody">
          <label>Model Yaw (¬∞)</label>
          <input type="range" min="-180" max="180" step="1" value="0" id="modelYaw">
          <label>Model Zoom</label>
          <input type="range" min="50" max="200" step="1" value="100" id="modelScale">
        </div>
      </div>

      <div class="sub" id="sub-room">
        <button class="subhdr" type="button">Room <span style="opacity:.7;font-weight:500">‚Äî drag X = yaw, drag Y = pitch</span></button>
        <div class="subbody">
          <label>Room Yaw (¬∞)</label>
          <input type="range" min="-180" max="180" step="1" value="20" id="roomYaw">
          <label>Room Pitch (¬∞)</label>
          <input type="range" min="-60" max="60" step="1" value="0" id="roomPitch">
        </div>
      </div>

    </div>
  </div>

  <label>Range of Motion</label>
  <div class="row">
    <button id="startROM">‚ñ∂Ô∏è Start ROM</button>
    <button id="resetROM">‚Ü∫ Reset ROM</button>
  </div>

  <label>Event Log</label>
  <pre id="log"></pre>
</div>

<!-- SVG goniometer (unchanged from your working build) -->
<div id="gonioHost" class="hide" aria-hidden="true">
  <svg id="gonioSvg" aria-label="Universal goniometer">
    <g id="viewport" transform="translate(0,0) scale(1)">
      <g id="rotWrap" transform="rotate(0)">
        <g id="mirrorWrap" transform="scale(1,1)">
          <g id="instrument">
            <g id="head">
              <circle r="120" fill="none" stroke="#94a3b8" stroke-width="1.6"/>
              <circle r="86"  fill="none" stroke="#94a3b8" stroke-width="0.9" opacity="0.65"/>
              <g id="ticks"></g>
              <g id="labelsFixed">
                <g id="numsOut"></g>
                <g id="numsInWrap"><g id="numsIn"></g></g>
              </g>
              <circle r="3.2" fill="#94a3b8"/>
            </g>
            <g id="armA_grp">
              <rect x="-10" y="120" width="20" height="260" rx="10" stroke="#ef4444" fill="none" stroke-width="3" />
              <line id="axisA" x1="0" y1="380" x2="0" y2="-116" stroke="#ef4444" stroke-width="1.6" opacity=".85" stroke-linecap="round"/>
              <g id="armA_ruler"></g>
              <circle id="armA_knob" cx="0" cy="380" r="10" fill="#ef4444"/>
            </g>
            <g id="armB_grp">
              <rect x="-10" y="-380" width="20" height="500" rx="10" stroke="#22c55e" fill="none" stroke-width="3"/>
              <line id="axisB" x1="0" y1="-380" x2="0" y2="124" stroke="#22c55e" stroke-width="1.6" opacity=".85" stroke-linecap="round"/>
              <g id="armB_ruler"></g>
              <circle id="armB_knob" cx="0" cy="-380" r="10" fill="#22c55e"/>
              <circle id="armB_handleKnob" cx="0" cy="-380" r="38" fill="rgba(0,0,0,0)" style="pointer-events:all"/>
              <rect   id="armB_handleShaft" x="-20" y="-380" width="40" height="500" fill="rgba(0,0,0,0)" style="pointer-events:all"/>
            </g>
          </g>
        </g>
      </g>
    </g>
  </svg>
</div>

<div id="msg">Loading‚Ä¶</div>
<div class="hud" id="hud">Angle: 0¬∞</div>
<div class="toast" id="toast">Preset updated</div>
<canvas id="c"></canvas>

<!-- Note bubble -->
<div id="note" class="note hide">
  <button class="x" id="noteClose">‚úï</button>
  <h4 id="noteTitle">Note</h4>
  <div id="noteBody" class="md">Loading‚Ä¶</div>
</div>

<script type="module">
import * as THREE from "three";
import { OrbitControls } from "three/addons/controls/OrbitControls.js";
import { GLTFLoader } from "three/addons/loaders/GLTFLoader.js";
import { DRACOLoader } from "three/addons/loaders/DRACOLoader.js";
import { KTX2Loader } from "three/addons/loaders/KTX2Loader.js";
import { MeshoptDecoder } from "three/addons/libs/meshopt_decoder.module.js";
import { EXRLoader } from "three/addons/loaders/EXRLoader.js";

/* ===== quick DOM helpers */
const $ = (id)=>document.getElementById(id);
const msg=$("msg"), hud=$("hud"), logEl=$("log");
const regionSel=$("regionSel"), motionSel=$("motionSel");
const log=(t)=>{ logEl.textContent+=t+"\\n"; logEl.scrollTop=logEl.scrollHeight; };

/* ===== start state */
const INIT = {
  roomYawDeg: 20,
  roomPitchDeg: 0,
  roomSphereRadius: 18,
  model: { yawDeg:-15, scale:1.0, x:0, y:0, z:0 },
  camera: { pos:{x:0.9,y:1.6,z:2.7}, target:{x:0,y:1.4,z:0} }
};

/* ===== motions */
const REGION_MOTIONS = {
  cervical_spine:["Flexion","Extension","Lateral Flexion","Rotation"],
  thoracic_lumbar_spine:["Flexion","Extension","Lateral Flexion","Rotation"],
  glenohumeral_joint:["Flexion","Extension","Abduction","Internal Rotation","External Rotation"],
  elbow_radioulnar:["Flexion","Extension","Pronation","Supination"],
  wrist:["Flexion","Extension","Radial Deviation","Ulnar Deviation"],
  hip:["Flexion","Extension","Abduction","Adduction","Internal Rotation","External Rotation"],
  knee:["Flexion","Extension"],
  talocrural_ankle:["Dorsiflexion","Plantarflexion"],
  transverse_tarsal_subtalar:["Inversion","Eversion"],
  fingers_mcp_pip_dip:["MCP Flexion","MCP Extension","PIP Flexion","PIP Extension","DIP Flexion","DIP Extension"],
  thumb_cmc_mcp_ip:["CMC Flexion","CMC Extension","CMC Abduction","CMC Adduction","MCP Flexion","MCP Extension","IP Flexion","IP Extension"],
  toes_mtp_pip_dip:["MTP Flexion","MTP Extension","PIP Flexion","PIP Extension","DIP Flexion","DIP Extension"]
};
function refreshMotions(){
  const list=REGION_MOTIONS?.[regionSel.value]||[];
  motionSel.innerHTML="";
  if(!list.length){ const o=document.createElement("option"); o.value=""; o.textContent="(No motions)"; motionSel.appendChild(o); return; }
  list.forEach(t=>{ const o=document.createElement("option"); o.value=t; o.textContent=t; motionSel.appendChild(o); });
}
refreshMotions(); regionSel.onchange=refreshMotions;

/* ===== three.js core */
const renderer=new THREE.WebGLRenderer({canvas:$("c"),antialias:true});
renderer.setPixelRatio(devicePixelRatio);
renderer.setSize(innerWidth,innerHeight);
renderer.outputColorSpace=THREE.SRGBColorSpace;
renderer.toneMapping=THREE.ACESFilmicToneMapping;
renderer.toneMappingExposure=0.95;

/* soft shadow floor (shadow-only, nearly invisible) */
renderer.shadowMap.enabled=true; renderer.shadowMap.type=THREE.PCFSoftShadowMap;

const scene=new THREE.Scene();
const camera=new THREE.PerspectiveCamera(45,innerWidth/innerHeight,0.1,100);
const controls=new OrbitControls(camera,renderer.domElement);
controls.enableDamping=true;
camera.position.set(INIT.camera.pos.x,INIT.camera.pos.y,INIT.camera.pos.z);
controls.target.set(INIT.camera.target.x,INIT.camera.target.y,INIT.camera.target.z);
controls.update();

/* lights */
scene.add(new THREE.HemisphereLight(0xffffff,0x333344,1.2));
const dl=new THREE.DirectionalLight(0xffffff,1); dl.position.set(3,4,2); dl.castShadow=true;
dl.shadow.mapSize.set(2048,2048); dl.shadow.radius=4; scene.add(dl);

/* shadow matte ground at y=0 */
const shadowMat=new THREE.ShadowMaterial({opacity:0.25});
const ground=new THREE.Mesh(new THREE.PlaneGeometry(50,50), shadowMat);
ground.rotation.x=-Math.PI/2; ground.position.y=0; ground.receiveShadow=true; ground.renderOrder=-1; scene.add(ground);

/* HDRI sphere + env */
const pmremGen=new THREE.PMREMGenerator(renderer); pmremGen.compileEquirectangularShader();
let bgSphere=null;
new EXRLoader().setPath("assets/").load("pt_evaluation_room.exr?v="+Date.now(), (tex)=>{
  const env=pmremGen.fromEquirectangular(tex); scene.environment=env.texture;
  const geo=new THREE.SphereGeometry(INIT.roomSphereRadius,96,96);
  const mat=new THREE.MeshBasicMaterial({map:tex, side:THREE.BackSide});
  bgSphere=new THREE.Mesh(geo,mat);
  bgSphere.rotation.set(THREE.MathUtils.degToRad(INIT.roomPitchDeg),THREE.MathUtils.degToRad(INIT.roomYawDeg),0);
  scene.add(bgSphere);
}, undefined, err=>console.error(err));

/* model */
let model=null;
const gltf=new GLTFLoader(); gltf.setMeshoptDecoder(MeshoptDecoder);
const draco=new DRACOLoader(); draco.setDecoderPath("https://unpkg.com/three@0.160.0/examples/jsm/libs/draco/"); gltf.setDRACOLoader(draco);
const ktx2=new KTX2Loader(); ktx2.setTranscoderPath("https://unpkg.com/three@0.160.0/examples/jsm/libs/basis/"); ktx2.detectSupport(renderer); gltf.setKTX2Loader(ktx2);
const MODEL_URL="./Athletic_Grace_1006002620_texture.glb";

function groundModel(){
  if(!model) return;
  const box=new THREE.Box3().setFromObject(model);
  const minY=box.min.y;
  model.position.y -= minY; // feet to y=0 after any scaling
}
function addFallback(){
  if(model) return;
  const g=new THREE.Group(); const m=new THREE.MeshStandardMaterial({color:0xa0a4ae, metalness:0.1, roughness:0.8});
  const mk=(geo,y,s=1)=>{ const x=new THREE.Mesh(geo,m); x.position.y=y; x.scale.setScalar(s); x.castShadow=true; g.add(x); };
  mk(new THREE.CapsuleGeometry(0.22,0.8,8,16),1.1);
  mk(new THREE.SphereGeometry(0.16,16,16),1.8);
  mk(new THREE.CylinderGeometry(0.1,0.12,0.3,12),1.45);
  mk(new THREE.CylinderGeometry(0.11,0.11,0.8,12),0.55);
  model=g; scene.add(model); groundModel();
}
(async ()=>{
  try{
    const h=await fetch(MODEL_URL,{method:"HEAD",cache:"no-store"}); if(!h.ok) throw 0;
    gltf.load(MODEL_URL,(g)=>{
      model=g.scene; model.traverse(o=>{ if(o.isMesh) o.castShadow=true; });
      scene.add(model);
      const box=new THREE.Box3().setFromObject(model);
      const c=box.getCenter(new THREE.Vector3());
      model.position.sub(new THREE.Vector3(c.x,0,c.z));
      model.scale.setScalar(INIT.model.scale);
      model.rotation.y=THREE.MathUtils.degToRad(INIT.model.yawDeg);
      groundModel();
      $("modelYaw").value=INIT.model.yawDeg;
      $("modelScale").value=Math.round(INIT.model.scale*100);
    }, undefined, ()=>addFallback());
  }catch{ addFallback(); }
})();

/* ===== Controllers accordion + sub sections ===== */
const accCtl=$("acc-controllers");
accCtl.querySelector(".hdr").onclick=()=>accCtl.classList.toggle("open");
const subG=$("sub-gonio"), subM=$("sub-model"), subR=$("sub-room");
[subG,subM,subR].forEach(s=>{
  s.querySelector(".subhdr").onclick=()=>s.classList.toggle("open");
});

/* gesture targeting by open sub section */
function activeMode(){
  if(subM.classList.contains("open")) return "model";
  if(subR.classList.contains("open")) return "room";
  return "camera";
}
let drag=null, pinch0=null, touches=new Map();
const canvas=$("c");

/* drag */
canvas.addEventListener("pointerdown",(e)=>{
  const mode=activeMode();
  if(mode==="camera"){ return; }
  e.preventDefault(); drag={mode, x:e.clientX, y:e.clientY};
  canvas.setPointerCapture(e.pointerId);
  // disable orbit while dragging model/room
  controls.enabled=false;
});
canvas.addEventListener("pointermove",(e)=>{
  if(!drag) return;
  const dx=e.clientX-drag.x, dy=e.clientY-drag.y; drag.x=e.clientX; drag.y=e.clientY;
  if(drag.mode==="model" && model){
    model.rotation.y += THREE.MathUtils.degToRad(dx*0.25);
    $("modelYaw").value=Math.round(THREE.MathUtils.radToDeg(model.rotation.y));
  }else if(drag.mode==="room" && bgSphere){
    bgSphere.rotation.y += THREE.MathUtils.degToRad(dx*0.25);
    bgSphere.rotation.x = THREE.MathUtils.clamp(bgSphere.rotation.x + THREE.MathUtils.degToRad(dy*0.25), THREE.MathUtils.degToRad(-60), THREE.MathUtils.degToRad(60));
    $("roomYaw").value=Math.round(THREE.MathUtils.radToDeg(bgSphere.rotation.y));
    $("roomPitch").value=Math.round(THREE.MathUtils.radToDeg(bgSphere.rotation.x));
  }
});
canvas.addEventListener("pointerup",()=>{ drag=null; controls.enabled=true; });

/* pinch for model zoom */
canvas.addEventListener("pointerdown",(e)=>touches.set(e.pointerId,{x:e.clientX,y:e.clientY}),{passive:true});
canvas.addEventListener("pointerup",(e)=>{ touches.delete(e.pointerId); pinch0=null; },{passive:true});
canvas.addEventListener("pointercancel",(e)=>{ touches.delete(e.pointerId); pinch0=null; },{passive:true});
canvas.addEventListener("pointermove",(e)=>{
  if(activeMode()!=="model" || !model) return;
  touches.set(e.pointerId,{x:e.clientX,y:e.clientY});
  if(touches.size===2){
    const a=[...touches.values()];
    const d=Math.hypot(a[0].x-a[1].x, a[0].y-a[1].y);
    if(pinch0==null){ pinch0=d; return; }
    const k=THREE.MathUtils.clamp(d/pinch0,0.5,2.0);
    let s=THREE.MathUtils.clamp(model.scale.x*k,0.5,2.0);
    model.scale.setScalar(s); groundModel();
    $("modelScale").value=Math.round(s*100);
    pinch0=d;
  }
},{passive:true});

/* sliders for model/room */
$("modelYaw").oninput=()=>{ if(model) model.rotation.y=THREE.MathUtils.degToRad(parseFloat($("modelYaw").value)); };
$("modelScale").oninput=()=>{ if(model){ const s=parseFloat($("modelScale").value)/100; model.scale.setScalar(THREE.MathUtils.clamp(s,0.5,2)); groundModel(); } };
$("roomYaw").oninput=()=>{ if(bgSphere) bgSphere.rotation.y=THREE.MathUtils.degToRad(parseFloat($("roomYaw").value)); };
$("roomPitch").oninput=()=>{ if(bgSphere) bgSphere.rotation.x=THREE.MathUtils.degToRad(parseFloat($("roomPitch").value)); };

/* ====== GONIOMETER + notes + ROM (same as your working version) ====== */
/* ‚Ä¶ keep your existing logic here (unchanged) ‚Ä¶ */
/* (Omitted in this reply for brevity‚Äîyour current code block already includes it.) */

/* resize & render */
addEventListener("resize",()=>{ camera.aspect=innerWidth/innerHeight; camera.updateProjectionMatrix(); renderer.setSize(innerWidth,innerHeight); });
(function loop(){ controls.update(); renderer.render(scene,camera); requestAnimationFrame(loop); })();

/* errors */
window.addEventListener('error',e=>{ msg.textContent='‚ùå '+(e.message||'Script error'); console.error(e); });
</script>
</body>
</html>
