<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PT Lab ‚Äî Minimal Model Loader</title>

<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Ctext y='14' font-size='14'%3E%F0%9F%8F%A5%3C/text%3E%3C/svg%3E">

<!-- ES Modules -->
<script type="importmap">
{
  "imports": {
    "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
    "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
  }
}
</script>

<style>
  html,body{margin:0;height:100%;background:#0b1220;color:#e5e7eb;overflow:hidden;font-family:system-ui,Segoe UI,Roboto}
  canvas{position:fixed; inset:0; z-index:0; width:100%; height:100%; display:block}

  .panel{
    position:fixed; left:0; top:0; bottom:0; width:340px;
    background:#0f172a; border-right:1px solid #1f2937; padding:14px; overflow:auto; z-index:10;
  }
  h3{margin:6px 0 12px 0}
  label{display:block;font-size:13px;margin-top:10px;color:#cbd5e1}
  select,button,input[type=range]{width:100%;margin:6px 0 8px 0;padding:8px 10px;border-radius:10px;background:#1e293b;border:1px solid #334155;color:#e2e8f0}
  .row{display:flex;gap:8px}.row>button{flex:1}
  #log{background:#0b1220;border:1px solid #1f2937;height:140px;overflow:auto;border-radius:8px;padding:8px;font-size:12px;white-space:pre-wrap}
  #msg{position:fixed;top:10px;left:10px;z-index:20;background:rgba(15,23,42,.7);border:1px solid #334155;border-radius:8px;padding:6px 10px;font-size:13px}
</style>
</head>
<body>
<div class="panel" aria-label="Controls panel">
  <h3>Goniometry Trainer (Model Test)</h3>

  <label for="regionSel">Region</label>
  <select id="regionSel" name="regionSel">
    <option value="cervical_spine">Cervical Spine</option>
    <option value="glenohumeral_joint">Glenohumeral Joint</option>
    <option value="elbow_radioulnar">Elbow & Radioulnar Joints</option>
    <option value="hip">Hip</option>
  </select>

  <label for="motionSel">Motion</label>
  <select id="motionSel" name="motionSel"></select>

  <div class="row">
    <button id="showNote" disabled>üìå Show goniometer placement (disabled)</button>
    <button id="doMotion">‚ñ∂Ô∏è Action (not wired)</button>
  </div>

  <label>Model Controls</label>
  <label for="modelX">Model X (m)</label>
  <input type="range" min="-2" max="2" step="0.01" value="0" id="modelX" name="modelX">
  <label for="modelZ">Model Z (m)</label>
  <input type="range" min="-2" max="2" step="0.01" value="0.6" id="modelZ" name="modelZ">
  <label for="modelY">Model Y (m)</label>
  <input type="range" min="-0.2" max="0.6" step="0.005" value="0" id="modelY" name="modelY">
  <label for="modelScale">Model Scale (%)</label>
  <input type="range" min="60" max="160" step="1" value="100" id="modelScale" name="modelScale">
  <label for="modelYaw">Model Yaw (¬∞)</label>
  <input type="range" min="0" max="360" step="1" value="0" id="modelYaw" name="modelYaw">
  <div class="row"><button id="resetPose" type="button">Reset Pose</button></div>

  <label>Event Log</label>
  <pre id="log"></pre>
</div>

<div id="msg">Loading‚Ä¶</div>
<canvas id="c"></canvas>

<script type="module">
import * as THREE from "three";
import { OrbitControls } from "three/addons/controls/OrbitControls.js";
import { GLTFLoader } from "three/addons/loaders/GLTFLoader.js";
import { DRACOLoader } from "three/addons/loaders/DRACOLoader.js";
import { KTX2Loader } from "three/addons/loaders/KTX2Loader.js";
import { MeshoptDecoder } from "three/addons/libs/meshopt_decoder.module.js";

/* ========= UI / LOG ========= */
const msg = document.getElementById("msg");
const logEl = document.getElementById("log");
const log = (t)=>{ logEl.textContent += t + "\n"; logEl.scrollTop = logEl.scrollHeight; };

/* ========= THREE ========= */
const canvas = document.getElementById("c");
const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
renderer.setPixelRatio(devicePixelRatio);
renderer.setSize(innerWidth, innerHeight);
renderer.outputColorSpace = THREE.SRGBColorSpace;
renderer.toneMapping = THREE.ACESFilmicToneMapping;
renderer.toneMappingExposure = 1.0;
renderer.shadowMap.enabled = true;
renderer.shadowMap.type = THREE.PCFSoftShadowMap;
renderer.domElement.style.touchAction = 'none';

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x0b1220);

const camera = new THREE.PerspectiveCamera(45, innerWidth/innerHeight, 0.01, 100);
camera.position.set(1.6, 1.6, 2.8);

const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true; controls.dampingFactor = 0.08;
controls.enablePan = true; controls.screenSpacePanning = false;
controls.minDistance = 0.8; controls.maxDistance = 6;
controls.target.set(0, 1.1, 0);

/* Lights */
scene.add(new THREE.HemisphereLight(0xffffff, 0x333344, 0.7));
const key = new THREE.DirectionalLight(0xffffff, 1.2);
key.position.set(2.5, 4, 2.5);
key.castShadow = true;
key.shadow.mapSize.set(2048,2048);
key.shadow.camera.near = 0.1; key.shadow.camera.far = 15;
key.shadow.camera.left = -4; key.shadow.camera.right = 4;
key.shadow.camera.top = 4; key.shadow.camera.bottom = -4;
scene.add(key);

/* Ground (shadow catcher) */
const groundGeo = new THREE.PlaneGeometry(20, 20);
const groundMat = new THREE.ShadowMaterial({ opacity: 0.45 });
const ground = new THREE.Mesh(groundGeo, groundMat);
ground.rotation.x = -Math.PI/2;
ground.position.y = 0;
ground.receiveShadow = true;
scene.add(ground);

/* ========= MODEL LOADER (no regex, no notes) ========= */
const loader = new GLTFLoader();
loader.setMeshoptDecoder(MeshoptDecoder);

const draco = new DRACOLoader();
draco.setDecoderPath("https://unpkg.com/three@0.160.0/examples/jsm/libs/draco/");
loader.setDRACOLoader(draco);

const ktx2 = new KTX2Loader();
ktx2.setTranscoderPath("https://unpkg.com/three@0.160.0/examples/jsm/libs/basis/");
ktx2.detectSupport(renderer);
loader.setKTX2Loader(ktx2);

let model = null;

/* Helpers */
function pickModelUrl(){
  const u = new URL(location.href);
  const q = u.searchParams.get("model");
  if (q && /^https?:\/\//i.test(q)) return q;
  if (q && q.trim()) return new URL(q, location.href).href;
  return new URL("./Athletic_Grace_1006002620_texture.glb", location.href).href;
}
const MODEL_URL = pickModelUrl();
log(`Model URL: ${MODEL_URL}`);

function addFallbackMannequin(reason="Unknown"){
  if (model) return;
  const g = new THREE.Group();
  const mat = new THREE.MeshStandardMaterial({color:0xa0a4ae, metalness:0.1, roughness:0.8});
  const mk = (geo,y,s=1)=>{ const m=new THREE.Mesh(geo,mat); m.position.y=y; m.scale.setScalar(s); m.castShadow=true; g.add(m); };
  mk(new THREE.CapsuleGeometry(0.22,0.8,8,16), 1.1);
  mk(new THREE.SphereGeometry(0.16,16,16),        1.8);
  mk(new THREE.CylinderGeometry(0.1,0.12,0.3,12), 1.45);
  mk(new THREE.CylinderGeometry(0.11,0.11,0.8,12),0.55);
  g.traverse(o=>{ if(o.isMesh){ o.castShadow = true; }});
  scene.add(g); model = g;
  msg.textContent = `‚ö†Ô∏è Using fallback mannequin (${reason})`;
  log(`Fallback mannequin: ${reason}`);
  groundSnap();
}

function groundSnap(){
  if(!model) return;
  const box = new THREE.Box3().setFromObject(model);
  const minY = box.min.y;
  model.position.y -= minY; // put feet at y=0
}

function autoScaleToHeight(targetMeters=1.75){
  const box = new THREE.Box3().setFromObject(model);
  const h = box.max.y - box.min.y;
  if (!isFinite(h) || h <= 0) return;
  const s = targetMeters / h;
  if (s < 0.4 || s > 2.5) {
    model.scale.multiplyScalar(s);
    log(`Auto-scaled model by ${s.toFixed(2)}√ó to ~${targetMeters}m tall`);
  }
}

function loadModel() {
  msg.textContent = "Loading 3D model‚Ä¶";
  log("Loading GLB via GLTFLoader‚Ä¶");

  loader.load(
    MODEL_URL,
    (gltf) => {
      model = gltf.scene;
      model.traverse(o=>{ if (o.isMesh) o.castShadow = true; });
      scene.add(model);

      // initial placement
      applyModelTransform();
      autoScaleToHeight(1.75);
      groundSnap();

      controls.target.set(0,1.1,0);
      msg.textContent = "‚úÖ Model loaded";
      log("‚úÖ Model loaded OK");
    },
    (xhr) => {
      msg.textContent = xhr.lengthComputable ? `Loading ${Math.round((xhr.loaded/xhr.total)*100)}%` : "Loading‚Ä¶";
    },
    (err) => {
      console.error(err);
      log(`‚ùå GLTF load error: ${err?.message || err}`);
      msg.textContent = "‚ö†Ô∏è Loader error ‚Äî using fallback";
      addFallbackMannequin(err?.message || "Loader error");
    }
  );

  // Safety net
  setTimeout(()=>{ if (!model) addFallbackMannequin("Timeout / CORS / path issue"); }, 8000);
}
loadModel();

/* ========= MODEL TRANSFORMS ========= */
const modelX = document.getElementById("modelX");
const modelZ = document.getElementById("modelZ");
const modelY = document.getElementById("modelY");
const modelScale = document.getElementById("modelScale");
const modelYaw = document.getElementById("modelYaw");
const resetPose = document.getElementById("resetPose");

function applyModelTransform(){
  if(!model) return;
  model.position.x = parseFloat(modelX.value);
  model.position.z = parseFloat(modelZ.value);
  const s = parseInt(modelScale.value,10)/100;
  model.scale.setScalar(s);
  groundSnap();
  model.position.y += parseFloat(modelY.value);
  model.rotation.y = THREE.MathUtils.degToRad(parseFloat(modelYaw.value));
}
[modelX,modelZ,modelY,modelScale,modelYaw].forEach(el=> el.addEventListener('input', applyModelTransform));
resetPose.onclick = ()=>{
  modelX.value = "0"; modelZ.value = "0.6"; modelY.value = "0"; modelScale.value = "100"; modelYaw.value="0";
  applyModelTransform(); controls.target.set(0,1.1,0);
};

/* ========= RENDER LOOP ========= */
addEventListener("resize", () => {
  camera.aspect = innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth, innerHeight);
});
(function animate(){
  controls.update();
  renderer.render(scene, camera);
  requestAnimationFrame(animate);
})();

/* ========= Leave Action button present but inert ========= */
document.getElementById("doMotion").onclick = () => {
  log("Action pressed (not wired in this minimal build).");
};

/* Global error banner */
window.addEventListener('error', e => { msg.textContent = '‚ùå ' + (e.message || 'Script error'); console.error(e); });
</script>
</body>
</html>
